<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BharatComfort Portal – Auth + Role Dashboards + Listings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b1220; --card:#101828; --muted:#182235; --text:#e6edf7; --sub:#a7b3c6; --accent:#22d3ee; --danger:#ef4444; --ok:#22c55e; }
    *{ box-sizing:border-box; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; }
    body{ margin:0; background:linear-gradient(180deg,#0b1220,#0b1220 40%,#0e1628); color:var(--text); }
    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px; }
    .nav{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .brand{ display:flex; gap:10px; align-items:center; }
    .brand-logo{ width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#22d3ee,#6366f1); display:grid; place-items:center; font-weight:800; color:#0b1220; }
    .tag{ color:var(--sub); font-size:12px; margin-left:6px; }
    .btn{ appearance:none; border:0; padding:10px 14px; border-radius:14px; background:var(--muted); color:var(--text); font-weight:600; cursor:pointer; transition:.2s; }
    .btn:hover{ filter:brightness(1.2); }
    .btn.acc{ background:linear-gradient(135deg,#22d3ee,#6366f1); color:#0b1220; }
    .btn.danger{ background: #3a1216; color:#fecaca; }
    .btn.ok{ background:#133323; color:#bbf7d0; }
    .card{ background:rgba(16,24,40,.7); border:1px solid #1f2a44; border-radius:20px; padding:16px; box-shadow:0 10px 20px rgba(0,0,0,.25); }
    .grid{ display:grid; gap:16px; }
    .grid.cols-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    .grid.cols-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    @media (max-width:960px){ .grid.cols-2, .grid.cols-3{ grid-template-columns:1fr; } }
    h1{ margin:0 0 12px 0; font-size:28px; }
    h2{ margin:8px 0 12px 0; font-size:20px; color:#dbe6ff; }
    label{ font-size:14px; color:var(--sub); display:block; margin:6px 0 6px; }
    input, select, textarea{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid #27324a; background:#0d1628; color:var(--text); outline:none; }
    input::placeholder, textarea::placeholder{ color:#7c8aa3; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ text-align:left; padding:10px; border-bottom:1px solid #1f2a44; font-size:14px; }
    .pill{ display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid #2a3552; background:#0e1830; font-size:12px; color:#cbd5e1; }
    .hidden{ display:none !important; }
    .notice{ padding:10px 12px; border-radius:12px; background:#0e1830; border:1px dashed #33436b; color:#cfe1ff; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab{ padding:8px 12px; border-radius:999px; background:#111b31; border:1px solid #28375e; cursor:pointer; font-size:14px; }
    .tab.active{ background:linear-gradient(135deg,#22d3ee,#6366f1); color:#0b1220; border-color:transparent; font-weight:700; }
    .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0d1628; border:1px solid #27324a; padding:2px 6px; border-radius:6px; }
    .link{ color:#93c5fd; text-decoration:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="brand">
        <div class="brand-logo">BC</div>
        <div>
          <div style="font-weight:800; letter-spacing:.2px;">BharatComfort Portal</div>
          <div class="tag">Auth • Roles • Dashboards • Listings (No-Code Forms)</div>
        </div>
      </div>
      <div>
        <button id="btnShowLogin" class="btn">Login</button>
        <button id="btnShowRegister" class="btn">Register</button>
        <span id="whoami" class="pill hidden"></span>
        <button id="btnLogout" class="btn danger hidden">Logout</button>
      </div>
    </div>

    <!-- ===== AUTH VIEWS ===== -->
    <div id="authViews" class="grid cols-2">
      <div id="loginCard" class="card">
        <h1>Login</h1>
        <label>Email</label>
        <input id="loginEmail" type="email" placeholder="you@example.com" />
        <label>Password</label>
        <input id="loginPassword" type="password" placeholder="••••••••" />
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="btnLogin" class="btn acc">Login</button>
          <button id="btnLoginGoogle" class="btn">Login with Google</button>
        </div>
        <p class="tag" style="margin-top:10px;">Forgot password? <a class="link" href="#" id="btnReset">Send reset email</a></p>
      </div>

      <div id="registerCard" class="card">
        <h1>Register</h1>
        <label>Full Name</label>
        <input id="regName" placeholder="Your Name" />
        <label>Email</label>
        <input id="regEmail" type="email" placeholder="you@example.com" />
        <label>Password</label>
        <input id="regPassword" type="password" placeholder="Minimum 6 characters" />
        <label>Register as</label>
        <select id="regRole">
          <option value="user">User</option>
          <option value="partner">Partner</option>
        </select>
        <div class="notice" style="margin-top:10px;">Admin/Super Admin can only be assigned by an existing Super Admin inside the Admin panel.</div>
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="btnRegister" class="btn ok">Create Account</button>
        </div>
      </div>
    </div>

    <!-- ===== DASHBOARDS WRAPPER ===== -->
    <div id="dashWrap" class="hidden">
      <div class="card" style="margin-bottom:16px;">
        <div class="tabs">
          <div class="tab" data-tab="userDash">User</div>
          <div class="tab" data-tab="partnerDash">Partner</div>
          <div class="tab" data-tab="adminDash">Admin</div>
          <div class="tab" data-tab="superDash">Super Admin</div>
        </div>
        <div class="tag">Tabs shown are based on your role. If you don't see a tab, you don't have that role.</div>
      </div>

      <!-- ===== USER DASHBOARD ===== -->
      <section id="userDash" class="card hidden">
        <h2>Discover Listings</h2>
        <div class="grid cols-3">
          <div>
            <label>Search by name</label>
            <input id="searchName" placeholder="e.g. Hotel Sunrise" />
          </div>
          <div>
            <label>City</label>
            <input id="searchCity" placeholder="e.g. Patna" />
          </div>
          <div>
            <label>Type</label>
            <select id="searchType">
              <option value="">All</option>
              <option>Hotel</option>
              <option>Restaurant</option>
              <option>Café</option>
              <option>Resort</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn" id="btnSearch">Search</button>
          <button class="btn" id="btnClearSearch">Clear</button>
        </div>
        <div style="margin-top:16px;" class="card">
          <table>
            <thead>
              <tr>
                <th>Name</th><th>City</th><th>Type</th><th>Rooms/Services</th><th>Price From</th><th>Link</th>
              </tr>
            </thead>
            <tbody id="listingsTable"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== PARTNER DASHBOARD ===== -->
      <section id="partnerDash" class="card hidden">
        <h2>Partner – Manage Your Listings</h2>
        <div class="grid cols-2">
          <div class="card">
            <h3>Quick Add Listing (No-Code)</h3>
            <div class="tag">Create hotel/restaurant entries via this form. Only you can edit/delete your listings.</div>
            <label>Business Name</label>
            <input id="pl_name" placeholder="Hotel/Restaurant Name" />
            <label>City</label>
            <input id="pl_city" placeholder="e.g. Patna" />
            <label>Type</label>
            <select id="pl_type">
              <option>Hotel</option><option>Restaurant</option><option>Café</option><option>Resort</option>
            </select>
            <label>Room Types (comma separated)</label>
            <input id="pl_rooms" placeholder="Deluxe, Suite, Family" />
            <label>Services (comma separated)</label>
            <input id="pl_services" placeholder="WiFi, Breakfast, Parking" />
            <label>Starting Price (₹)</label>
            <input id="pl_price" type="number" placeholder="1500" />
            <label>Website / Booking URL</label>
            <input id="pl_link" placeholder="https://..." />
            <div style="display:flex; gap:8px; margin-top:12px;">
              <button class="btn ok" id="pl_add">Add Listing</button>
            </div>
          </div>

          <div class="card">
            <h3>Bulk Add via CSV (Optional)</h3>
            <div class="tag">Headers required: name,city,type,rooms,services,price,link</div>
            <input type="file" id="pl_csv" accept=".csv" />
            <div style="margin-top:10px;">
              <button class="btn" id="pl_import">Import CSV</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <h3>Your Listings</h3>
          <table>
            <thead>
              <tr><th>Name</th><th>City</th><th>Type</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody id="partnerListings"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== ADMIN DASHBOARD ===== -->
      <section id="adminDash" class="card hidden">
        <h2>Admin – Approvals & All Listings</h2>
        <div class="grid cols-2">
          <div class="card">
            <h3>All Listings</h3>
            <table>
              <thead>
                <tr><th>Name</th><th>Owner</th><th>City</th><th>Type</th><th>Status</th><th>Action</th></tr>
              </thead>
              <tbody id="adminListings"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>User Roles</h3>
            <div class="tag">Promote/demote users. Only Super Admin can manage Admin/Super roles.</div>
            <label>User Email</label>
            <input id="role_email" placeholder="user@domain.com" />
            <label>Assign Role</label>
            <select id="role_role">
              <option value="user">User</option>
              <option value="partner">Partner</option>
              <option value="admin">Admin</option>
            </select>
            <div style="margin-top:10px;">
              <button class="btn" id="role_set">Set Role</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== SUPER ADMIN DASHBOARD ===== -->
      <section id="superDash" class="card hidden">
        <h2>Super Admin – Platform Controls</h2>
        <div class="grid cols-2">
          <div class="card">
            <h3>Manage Admins/Supers</h3>
            <label>Email</label>
            <input id="sa_email" placeholder="admin@domain.com" />
            <label>Role</label>
            <select id="sa_role">
              <option value="admin">Admin</option>
              <option value="superadmin">Super Admin</option>
              <option value="partner">Partner</option>
              <option value="user">User</option>
            </select>
            <div style="margin-top:10px;"><button class="btn acc" id="sa_set">Update Role</button></div>
            <p class="tag">Use carefully. This can elevate users to Super Admin.</p>
          </div>

          <div class="card">
            <h3>Platform Info</h3>
            <div class="notice">
              <div><b>Collections</b>: <span class="kbd">users</span>, <span class="kbd">listings</span></div>
              <div><b>Statuses</b>: <span class="kbd">pending</span>, <span class="kbd">approved</span>, <span class="kbd">rejected</span></div>
              <div><b>Bootstrap</b>: add your email in <span class="kbd">SUPER_ADMINS</span> below before first use.</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="card" style="margin-top:18px;">
      <h2>Setup Guide (Read Once)</h2>
      <ol>
        <li>Create a Firebase project → Web App → copy config.</li>
        <li>Enable <b>Email/Password</b> and <b>Google</b> providers in <em>Authentication</em>.</li>
        <li>Create <span class="kbd">Firestore</span> (production mode), region close to India.</li>
        <li>Edit <span class="kbd">firebaseConfig</span> and <span class="kbd">SUPER_ADMINS</span> in the script below.</li>
        <li>Deploy this single HTML on your hosting (or open locally for testing).</li>
        <li>First login using a Super Admin email → you'll see all tabs.</li>
      </ol>
      <div class="notice">Optional: set Firestore <b>Security Rules</b> from the comment at the end of this file.</div>
    </div>

  </div>

  <!-- ===== FIREBASE (v10 modular CDN) ===== -->
  <script type="module">
    // ---- 1) CONFIG ----
    const firebaseConfig = {
      apiKey: "AIzaSyCIyByoZatiJno8fsVoaEsKHnYq75er6AE",
      authDomain: "bharatcomfort-46bac.firebaseapp.com",
      projectId: "bharatcomfort-46bac",
      storageBucket: "bharatcomfort-46bac.firebasestorage.app",
      messagingSenderId: "566612210879",
      appId: "1:566612210879:web:25dfd26a5444f08c9d820a"
    };

    // Add initial super admins here for bootstrap
    const SUPER_ADMINS = [
      // "shrrajbhar12340@gmail.com",
      // "bharatcomfort85@gmail.com"
    ];

    // ---- 2) INIT ----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- 3) HELPERS ----
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');

    const state = { user:null, role:null, profile:null };

    async function ensureUserDoc(u){
      const uref = doc(db,'users',u.uid);
      const snap = await getDoc(uref);
      if(!snap.exists()){
        const defaultRole = SUPER_ADMINS.includes(u.email) ? 'superadmin' : 'user';
        await setDoc(uref,{
          uid:u.uid, email:u.email, name:u.displayName||'', role: defaultRole, createdAt: serverTimestamp()
        });
        return { role: defaultRole };
      }
      return snap.data();
    }

    function setRoleUI(role){
      state.role = role;
      const who = $("whoami");
      who.textContent = `${state.user.email} • ${role}`;
      show(who); show($("btnLogout")); hide($("authViews")); show($("dashWrap"));

      // tabs visibility
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(t=>t.classList.remove('active'));
      const showUser = ['user','partner','admin','superadmin'].includes(role);
      const showPartner = ['partner','admin','superadmin'].includes(role);
      const showAdmin = ['admin','superadmin'].includes(role);
      const showSuper = ['superadmin'].includes(role);
      toggleSection('userDash', showUser);
      toggleSection('partnerDash', showPartner);
      toggleSection('adminDash', showAdmin);
      toggleSection('superDash', showSuper);

      // default active tab
      const firstTabId = showSuper ? 'superDash' : showAdmin ? 'adminDash' : showPartner ? 'partnerDash' : 'userDash';
      activateTab(firstTabId);

      loadListingsTable();
      if(showPartner) loadPartnerListings();
      if(showAdmin) loadAdminListings();
    }

    function toggleSection(id, visible){
      const tab = document.querySelector(`.tab[data-tab="${id}"]`);
      const sec = $(id);
      if(visible){ show(tab); show(sec);} else { hide(tab); hide(sec);}    
    }

    function activateTab(id){
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(t=> t.classList.toggle('active', t.getAttribute('data-tab')===id));
      document.querySelectorAll('#dashWrap section').forEach(s=> hide(s));
      show($(id));
    }

    document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=> activateTab(t.getAttribute('data-tab'))));

    // ---- 4) AUTH EVENTS ----
    $("btnLogin").onclick = async ()=>{
      const email=$("loginEmail").value.trim();
      const pass=$("loginPassword").value;
      if(!email||!pass) return alert('Enter email/password');
      await signInWithEmailAndPassword(auth,email,pass).catch(e=>alert(e.message));
    };
    $("btnLoginGoogle").onclick = async ()=>{
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth,provider).catch(e=>alert(e.message));
    };
    $("btnReset").onclick = async ()=>{
      const email=$("loginEmail").value.trim();
      if(!email) return alert('Enter your email above first');
      await sendPasswordResetEmail(auth,email).then(()=>alert('Reset email sent')).catch(e=>alert(e.message));
    };
    $("btnRegister").onclick = async ()=>{
      const name=$("regName").value.trim();
      const email=$("regEmail").value.trim();
      const pass=$("regPassword").value;
      const roleSel=$("regRole").value;
      if(!name||!email||pass.length<6) return alert('Fill all fields. Password >= 6.');
      const cred = await createUserWithEmailAndPassword(auth,email,pass).catch(e=>alert(e.message));
      if(!cred) return;
      const profile = await ensureUserDoc(cred.user);
      // update role to selected if not superadmin bootstrap
      const uref = doc(db,'users',cred.user.uid);
      await updateDoc(uref,{ name, role: SUPER_ADMINS.includes(email)? 'superadmin' : roleSel });
    };
    $("btnLogout").onclick = ()=> signOut(auth);

    $("btnShowLogin").onclick = ()=>{ show($("authViews")); show($("loginCard")); hide($("registerCard")); };
    $("btnShowRegister").onclick = ()=>{ show($("authViews")); show($("registerCard")); hide($("loginCard")); };

    onAuthStateChanged(auth, async (u)=>{
      if(u){
        state.user=u;
        const profile = await ensureUserDoc(u);
        state.profile=profile;
        setRoleUI(profile.role||'user');
      } else {
        state.user=null; state.role=null; hide($("dashWrap")); show($("authViews")); hide($("btnLogout")); hide($("whoami"));
      }
    });

    // ---- 5) LISTINGS (COMMON) ----
    function listingRow(l){
      const svc = (l.rooms||[]).join('/') + ' • ' + (l.services||[]).join('/');
      const price = l.price ? `₹${l.price}`: '-';
      const link = l.link? `<a class="link" href="${l.link}" target="_blank">Visit</a>` : '-';
      return `<tr><td>${l.name}</td><td>${l.city||''}</td><td>${l.type||''}</td><td>${svc}</td><td>${price}</td><td>${link}</td></tr>`;
    }

    async function loadListingsTable(){
      // simple client-side query using search inputs
      const qname = $("searchName").value.trim().toLowerCase();
      const qcity = $("searchCity").value.trim().toLowerCase();
      const qtype = $("searchType").value;
      const snap = await getDocs(query(collection(db,'listings'), orderBy('createdAt')));
      const rows=[];
      snap.forEach(d=>{
        const l = d.data();
        if(l.status!=='approved') return;
        if(qname && !l.name.toLowerCase().includes(qname)) return;
        if(qcity && (l.city||'').toLowerCase()!==qcity) return;
        if(qtype && l.type!==qtype) return;
        rows.push(listingRow(l));
      });
      $("listingsTable").innerHTML = rows.join('')||`<tr><td colspan="6">No results</td></tr>`;
    }
    $("btnSearch").onclick = loadListingsTable;
    $("btnClearSearch").onclick = ()=>{ $("searchName").value=''; $("searchCity").value=''; $("searchType").value=''; loadListingsTable(); };

    // ---- 6) PARTNER CRUD ----
    async function addListing(ownerId, data){
      const payload = {
        name:data.name, city:data.city, type:data.type,
        rooms:(data.rooms||'').split(',').map(s=>s.trim()).filter(Boolean),
        services:(data.services||'').split(',').map(s=>s.trim()).filter(Boolean),
        price: Number(data.price)||null, link:data.link||'', ownerId,
        status:'pending', createdAt: serverTimestamp()
      };
      await addDoc(collection(db,'listings'), payload);
      alert('Listing submitted. Awaiting admin approval.');
      loadPartnerListings();
    }

    $("pl_add").onclick = ()=>{
      if(!state.user) return alert('Login required');
      const data = { name:$("pl_name").value, city:$("pl_city").value, type:$("pl_type").value, rooms:$("pl_rooms").value, services:$("pl_services").value, price:$("pl_price").value, link:$("pl_link").value };
      if(!data.name||!data.city) return alert('Name and City are required');
      addListing(state.user.uid, data);
    };

    $("pl_import").onclick = ()=>{
      const f = $("pl_csv").files[0];
      if(!f) return alert('Choose a CSV file');
      const r = new FileReader();
      r.onload = async ()=>{
        const lines = r.result.split(/\r?\n/).filter(Boolean);
        const headers = lines.shift().split(',').map(x=>x.trim().toLowerCase());
        const req = ['name','city','type','rooms','services','price','link'];
        for(const h of req){ if(!headers.includes(h)) return alert('Missing header: '+h); }
        for(const line of lines){
          const cols = line.split(',');
          const obj = Object.fromEntries(headers.map((h,i)=>[h, cols[i]||'']));
          await addListing(state.user.uid, obj);
        }
        alert('CSV imported for review');
      };
      r.readAsText(f);
    };

    async function loadPartnerListings(){
      if(!state.user) return;
      const q1 = query(collection(db,'listings'), where('ownerId','==', state.user.uid));
      const snap = await getDocs(q1);
      const rows=[];
      snap.forEach(d=>{
        const l=d.data();
        rows.push(`<tr>
          <td>${l.name}</td><td>${l.city}</td><td>${l.type}</td><td><span class="pill">${l.status}</span></td>
          <td>
            <button class="btn" onclick="window.__editListing('${d.id}')">Edit</button>
            <button class="btn danger" onclick="window.__deleteListing('${d.id}')">Delete</button>
          </td>
        </tr>`);
      });
      $("partnerListings").innerHTML = rows.join('')||`<tr><td colspan="5">No listings yet</td></tr>`;
    }

    window.__deleteListing = async (id)=>{
      if(!confirm('Delete listing?')) return;
      await deleteDoc(doc(db,'listings',id));
      loadPartnerListings();
    }

    window.__editListing = async (id)=>{
      const snap = await getDoc(doc(db,'listings',id));
      if(!snap.exists()) return alert('Not found');
      const l=snap.data();
      const name = prompt('Name', l.name)||l.name;
      const city = prompt('City', l.city)||l.city;
      const type = prompt('Type', l.type)||l.type;
      const rooms = prompt('Rooms (comma)', (l.rooms||[]).join(', '))||'';
      const services = prompt('Services (comma)', (l.services||[]).join(', '))||'';
      const price = prompt('Starting Price', l.price||'')||'';
      const link = prompt('Link', l.link||'')||'';
      await updateDoc(doc(db,'listings',id),{ name, city, type, rooms:rooms.split(',').map(s=>s.trim()).filter(Boolean), services:services.split(',').map(s=>s.trim()).filter(Boolean), price: Number(price)||null, link });
      alert('Updated');
      loadPartnerListings();
    }

    // ---- 7) ADMIN PANEL ----
    async function loadAdminListings(){
      const snap = await getDocs(query(collection(db,'listings')));
      const rows=[];
      for (const d of snap.docs){
        const l=d.data();
        const owner = l.ownerId ? await getDoc(doc(db,'users', l.ownerId)).then(s=>s.data()?.email||'—') : '—';
        rows.push(`<tr>
          <td>${l.name}</td><td>${owner}</td><td>${l.city}</td><td>${l.type}</td>
          <td><span class="pill">${l.status}</span></td>
          <td>
            <button class="btn ok" onclick="window.__setStatus('${d.id}','approved')">Approve</button>
            <button class="btn" onclick="window.__setStatus('${d.id}','pending')">Pending</button>
            <button class="btn danger" onclick="window.__setStatus('${d.id}','rejected')">Reject</button>
          </td>
        </tr>`);
      }
      $("adminListings").innerHTML = rows.join('')||`<tr><td colspan="6">No listings</td></tr>`;
    }

    window.__setStatus = async (id, status)=>{
      if(!['approved','pending','rejected'].includes(status)) return;
      await updateDoc(doc(db,'listings',id),{ status });
      loadAdminListings();
      loadListingsTable();
    }

    async function setRoleByEmail(email, role){
      // find user by email (simple scan of users collection)
      const usnap = await getDocs(collection(db,'users'));
      let found=null;
      usnap.forEach(d=>{ if(d.data().email===email) found={ id:d.id, ...d.data() }; });
      if(!found) return alert('User not found: ensure the user has registered/logged in once.');
      if(role==='admin' && state.role!=='superadmin') return alert('Only Super Admin can assign Admin role');
      if(role==='superadmin' && state.role!=='superadmin') return alert('Only Super Admin can assign Super Admin role');
      await updateDoc(doc(db,'users',found.id),{ role });
      alert('Role updated');
      if(found.id===state.user.uid){ setRoleUI(role); }
    }

    $("role_set").onclick = ()=>{
      const email=$("role_email").value.trim();
      const role=$("role_role").value;
      if(!email) return alert('Email required');
      setRoleByEmail(email, role);
    };

    $("sa_set").onclick = ()=>{
      const email=$("sa_email").value.trim();
      const role=$("sa_role").value;
      if(!email) return alert('Email required');
      setRoleByEmail(email, role);
    };

    // Initial view
    $("btnShowLogin").click();
  </script>

      }
    }
  }
  -->
</body>
</html>
